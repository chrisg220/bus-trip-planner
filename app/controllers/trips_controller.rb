#!/bin/env ruby
# encoding: utf-8

class TripsController < ApplicationController
  before_filter :authenticate_user!, :only => [:edit, :update, :delete, :save]

  def index
    # eventually this should only be trips that current_user has access to
    @trips = Trip.all
  end

  def new
    # anybody can create a trip and view the results
    @trip = Trip.new
  end

  def create
    require 'uri'
    require 'open-uri'
    require 'json'

    @trip = Trip.new(params[:trip])
    origin = params[:trip][:origin_name]
    destination = params[:trip][:destination_name]

    time = (Time.now + 300).to_i.to_s

    sensor = false
    mode = "transit"
    alternatives = true
    time_by = "departure" # or arrival


    #http://maps.googleapis.com/maps/api/directions/json?origin=511%20North%20Boren%20Ave&destination=Northgate%20Mall,Seattle&sensor=false&mode=transit&alternatives=true&departure_time=1344905500
    url = "http://maps.googleapis.com/maps/api/directions/json?origin=" + origin +
              "&destination=" + destination +
              "&sensor=" + sensor.to_s +
              "&mode=" + mode +
              "&alternatives=" + alternatives.to_s +
              "&" + time_by + "_time=" + time

    #json = open(URI.escape(url)).read
    #parsed = JSON.parse(json)

    parsed = {"routes"=>[{"bounds"=>{"northeast"=>{"lat"=>47.62913, "lng"=>-122.33658}, "southwest"=>{"lat"=>47.60842, "lng"=>-122.3489}}, "copyrights"=>"Map data ©2013 Google, Sanborn", "legs"=>[{"arrival_time"=>{"text"=>"9:26am", "time_zone"=>"America/Los_Angeles", "value"=>1363623978}, "departure_time"=>{"text"=>"9:10am", "time_zone"=>"America/Los_Angeles", "value"=>1363623036}, "distance"=>{"text"=>"1.8 mi", "value"=>2899}, "duration"=>{"text"=>"16 mins", "value"=>966}, "end_address"=>"Seattle, WA 98109, USA", "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "start_address"=>"Seattle, WA 98101, USA", "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"0.1 mi", "value"=>240}, "duration"=>{"text"=>"3 mins", "value"=>188}, "end_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "html_instructions"=>"Walk to 3rd Ave & Pike St", "polyline"=>{"points"=>"soqaHrztiVaA|@gEtDcBzAGQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"0.1 mi", "value"=>240}, "duration"=>{"text"=>"3 mins", "value"=>188}, "end_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "html_instructions"=>"Head <b>northwest</b> on <b>3rd Ave</b> toward <b>Union St</b>", "polyline"=>{"points"=>"soqaHrztiVaA|@gEtDcBzAGQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"1.6 mi", "value"=>2595}, "duration"=>{"text"=>"12 mins", "value"=>734}, "end_location"=>{"lat"=>47.62913, "lng"=>-122.34612}, "html_instructions"=>"Bus towards N Queen Anne, Seattle Center E", "polyline"=>{"points"=>"i{qaHpduiVDNs@n@k@j@qDpDyCbGi@fAoBxDyCfGeBhDq@vAw@|A_BzCCHEHgBnDmBzDo@nA}@hB_AqAcAyAq@}@KKIAQE{@AE?c@?U@i@AO?_A?u@?kDCW?K?Y?mA?wCAUQwECcA?kD?SNoDAiD@?_C?kB?YoD?o@?c@?yAAuA?yA?k@A?U"}, "start_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "transit_details"=>{"arrival_stop"=>{"location"=>{"lat"=>47.6291275, "lng"=>-122.346123}, "name"=>"Taylor Ave N & Prospect St"}, "arrival_time"=>{"text"=>"9:25am", "time_zone"=>"America/Los_Angeles", "value"=>1363623936}, "departure_stop"=>{"location"=>{"lat"=>47.6102905, "lng"=>-122.338173}, "name"=>"3rd Ave & Pike St"}, "departure_time"=>{"text"=>"9:13am", "time_zone"=>"America/Los_Angeles", "value"=>1363623202}, "headsign"=>"N Queen Anne, Seattle Center E", "line"=>{"agencies"=>[{"name"=>"Metro Transit", "phone"=>"(206) 553-3000", "url"=>"http://metro.kingcounty.gov/"}], "short_name"=>"3", "url"=>"http://metro.kingcounty.gov/tops/bus/schedules/s003_0_.html", "vehicle"=>{"icon"=>"//maps.gstatic.com/mapfiles/transit/iw/6/bus.png", "name"=>"Bus", "type"=>"BUS"}}, "num_stops"=>8}, "travel_mode"=>"TRANSIT"}, {"distance"=>{"text"=>"210 ft", "value"=>64}, "duration"=>{"text"=>"1 min", "value"=>44}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Walk to Seattle, WA 98109, USA", "polyline"=>{"points"=>"aquaHfvviV?Tj@??kB"}, "start_location"=>{"lat"=>47.62913, "lng"=>-122.34612}, "steps"=>[{"distance"=>{"text"=>"79 ft", "value"=>24}, "duration"=>{"text"=>"1 min", "value"=>14}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34623}, "html_instructions"=>"Head <b>south</b> on <b>Taylor Ave N</b> toward <b>Prospect St</b>", "polyline"=>{"points"=>"aquaHfvviV?Tj@?"}, "start_location"=>{"lat"=>47.62913, "lng"=>-122.34612}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"131 ft", "value"=>40}, "duration"=>{"text"=>"1 min", "value"=>30}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Turn <b>left</b> onto <b>Prospect St</b>", "polyline"=>{"points"=>"uouaH|vviV?kB"}, "start_location"=>{"lat"=>47.62891, "lng"=>-122.34623}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}], "via_waypoint"=>[]}], "overview_polyline"=>{"points"=>"soqaHrztiViGrFcBzAGQDNs@n@}E|EmMlWwC`GwCxF_F~JmBxDcCkD}@iA[GaAAy@@oDAiFCeFAUQwECoF?SNoDAiD@?_C?eC}IAoD?k@A?U?Tj@??kB"}, "warnings"=>["Walking directions are in beta.    Use caution – This route may be missing sidewalks or pedestrian paths."], "waypoint_order"=>[]}, {"bounds"=>{"northeast"=>{"lat"=>47.63237, "lng"=>-122.33658}, "southwest"=>{"lat"=>47.60842, "lng"=>-122.3461}}, "copyrights"=>"Map data ©2013 Google", "legs"=>[{"arrival_time"=>{"text"=>"9:29am", "time_zone"=>"America/Los_Angeles", "value"=>1363624184}, "departure_time"=>{"text"=>"9:11am", "time_zone"=>"America/Los_Angeles", "value"=>1363623062}, "distance"=>{"text"=>"2.3 mi", "value"=>3627}, "duration"=>{"text"=>"19 mins", "value"=>1115}, "end_address"=>"Seattle, WA 98109, USA", "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "start_address"=>"Seattle, WA 98101, USA", "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"98 ft", "value"=>30}, "duration"=>{"text"=>"1 min", "value"=>21}, "end_location"=>{"lat"=>47.60869, "lng"=>-122.3367}, "html_instructions"=>"Walk to 3rd Ave & Union St", "polyline"=>{"points"=>"soqaHrztiVm@h@GQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"98 ft", "value"=>30}, "duration"=>{"text"=>"1 min", "value"=>21}, "end_location"=>{"lat"=>47.60869, "lng"=>-122.3367}, "html_instructions"=>"Head <b>northwest</b> on <b>3rd Ave</b> toward <b>Union St</b>", "polyline"=>{"points"=>"soqaHrztiVm@h@GQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"1.9 mi", "value"=>3011}, "duration"=>{"text"=>"10 mins", "value"=>616}, "end_location"=>{"lat"=>47.63237, "lng"=>-122.34332}, "html_instructions"=>"Bus towards Aurora Village, Via Aurora Ave N", "polyline"=>{"points"=>"iqqaHj{tiVFPSRgErDyCjCk@j@eAdAkBjByCbGi@fAoBxDyCfGeBhDq@vAw@|A_BzCCHaAuAm@y@KQGIaAwA{@iAGIeA{Ac@o@CEIIIQ_@Ha@B{@?SC]EA?g@Im@C{DHqBDwBPi@?_ECiFAy@?O?[?M?O?Q?M?yA?E?C?_@?kCCiBCaACuCIY?}IIqI?iDCmD?A?I??S"}, "start_location"=>{"lat"=>47.60869, "lng"=>-122.3367}, "transit_details"=>{"arrival_stop"=>{"location"=>{"lat"=>47.6323738, "lng"=>-122.343315}, "name"=>"Aurora Ave N & Galer St"}, "arrival_time"=>{"text"=>"9:22am", "time_zone"=>"America/Los_Angeles", "value"=>1363623732}, "departure_stop"=>{"location"=>{"lat"=>47.6086884, "lng"=>-122.3367}, "name"=>"3rd Ave & Union St"}, "departure_time"=>{"text"=>"9:11am", "time_zone"=>"America/Los_Angeles", "value"=>1363623116}, "headsign"=>"Aurora Village, Via Aurora Ave N", "line"=>{"agencies"=>[{"name"=>"Metro Transit", "phone"=>"(206) 553-3000", "url"=>"http://metro.kingcounty.gov/"}], "short_name"=>"358", "url"=>"http://metro.kingcounty.gov/tops/bus/schedules/s358_0_.html", "vehicle"=>{"icon"=>"//maps.gstatic.com/mapfiles/transit/iw/6/bus.png", "name"=>"Bus", "type"=>"BUS"}}, "num_stops"=>6}, "travel_mode"=>"TRANSIT"}, {"distance"=>{"text"=>"0.4 mi", "value"=>586}, "duration"=>{"text"=>"8 mins", "value"=>478}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Walk to Seattle, WA 98109, USA", "polyline"=>{"points"=>"ievaHvdviVB?AN?@?^?B?V?V?D?@@@B@F??d@?DAF?BCDAB?HAf@?\\@D?BFV@D?J?B@D?@?@CBEDBPHQ@CBA@A@ADA\\?z@?|@?bD?fDEF?F?vC??zC"}, "start_location"=>{"lat"=>47.63237, "lng"=>-122.34332}, "steps"=>[{"distance"=>{"text"=>"164 ft", "value"=>50}, "duration"=>{"text"=>"1 min", "value"=>64}, "end_location"=>{"lat"=>47.63229, "lng"=>-122.34389}, "html_instructions"=>"Head <b>west</b><div style=\"font-size:0.9em\">Take the stairs</div>", "polyline"=>{"points"=>"ievaHvdviVB?AN?@?^?B?V?V?D?@@@B@F?"}, "start_location"=>{"lat"=>47.63237, "lng"=>-122.34332}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"312 ft", "value"=>95}, "duration"=>{"text"=>"2 mins", "value"=>123}, "end_location"=>{"lat"=>47.6323, "lng"=>-122.34509}, "html_instructions"=>"Turn <b>right</b> onto <b>Galer St</b><div style=\"font-size:0.9em\">Take the stairs</div>", "polyline"=>{"points"=>"ydvaHhhviV?d@?DAF?BCDAB?HAf@?\\@D?BFV@D?J?B@D?@?@CBEDBP"}, "start_location"=>{"lat"=>47.63229, "lng"=>-122.34389}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"0.2 mi", "value"=>382}, "duration"=>{"text"=>"4 mins", "value"=>241}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34491}, "html_instructions"=>"Turn <b>left</b> onto <b>6th Ave N</b>", "polyline"=>{"points"=>"{dvaHxoviVHQ@CBA@A@ADA\\?z@?|@?bD?fDEF?F?vC?"}, "start_location"=>{"lat"=>47.6323, "lng"=>-122.34509}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"194 ft", "value"=>59}, "duration"=>{"text"=>"1 min", "value"=>50}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Turn <b>right</b> onto <b>Prospect St</b>", "polyline"=>{"points"=>"uouaHtnviV?zC"}, "start_location"=>{"lat"=>47.62891, "lng"=>-122.34491}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}], "via_waypoint"=>[]}], "overview_polyline"=>{"points"=>"soqaHrztiVm@h@GQFPSRaJ~HqBpBkBjByCbGyC`GiJfRcBdDoBoCS[}BaDuB{CS[_@Ha@BoAC_@Eg@Im@CmHNwBPi@?iLEsB?_IC{IQ}IIqI?wICK??SB?AP?b@?v@DBF??d@ALCHCrAJf@@VCDEDBPJUDCFCxA?`F?nDE~C??zC"}, "warnings"=>["Walking directions are in beta.    Use caution – This route may be missing sidewalks or pedestrian paths."], "waypoint_order"=>[]}, {"bounds"=>{"northeast"=>{"lat"=>47.62979000000001, "lng"=>-122.33658}, "southwest"=>{"lat"=>47.60842, "lng"=>-122.35671}}, "copyrights"=>"Map data ©2013 Google, Sanborn", "legs"=>[{"arrival_time"=>{"text"=>"9:26am", "time_zone"=>"America/Los_Angeles", "value"=>1363623969}, "departure_time"=>{"text"=>"9:00am", "time_zone"=>"America/Los_Angeles", "value"=>1363622431}, "distance"=>{"text"=>"2.6 mi", "value"=>4254}, "duration"=>{"text"=>"26 mins", "value"=>1559}, "end_address"=>"Seattle, WA 98109, USA", "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "start_address"=>"Seattle, WA 98101, USA", "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"0.1 mi", "value"=>240}, "duration"=>{"text"=>"3 mins", "value"=>188}, "end_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "html_instructions"=>"Walk to 3rd Ave & Pike St", "polyline"=>{"points"=>"soqaHrztiVaA|@gEtDcBzAGQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"0.1 mi", "value"=>240}, "duration"=>{"text"=>"3 mins", "value"=>188}, "end_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "html_instructions"=>"Head <b>northwest</b> on <b>3rd Ave</b> toward <b>Union St</b>", "polyline"=>{"points"=>"soqaHrztiVaA|@gEtDcBzAGQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"2.0 mi", "value"=>3139}, "duration"=>{"text"=>"14 mins", "value"=>813}, "end_location"=>{"lat"=>47.62979000000001, "lng"=>-122.35652}, "html_instructions"=>"Bus towards Seattle Pacific University, Seattle Center W", "polyline"=>{"points"=>"i{qaHpduiVDNs@n@k@j@qDpDyCbGi@fAoBxDyCfGeBhDq@vAw@|A_BzCCHEHgBnDmBzDo@nA}@hBoBzDmBzD~@vAx@fAHL~@rAbAvAq@rAiBrDa@`AwAzCYn@_@t@{@?mDAiF?gFAyEAOAeGA_@?mC?AdGs@?wBA}C?O?{BCs@?q@?mA?kDIk@A?S"}, "start_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "transit_details"=>{"arrival_stop"=>{"location"=>{"lat"=>47.6297913, "lng"=>-122.356522}, "name"=>"Queen Anne Ave N & Highland Dr"}, "arrival_time"=>{"text"=>"9:16am", "time_zone"=>"America/Los_Angeles", "value"=>1363623410}, "departure_stop"=>{"location"=>{"lat"=>47.6102905, "lng"=>-122.338173}, "name"=>"3rd Ave & Pike St"}, "departure_time"=>{"text"=>"9:03am", "time_zone"=>"America/Los_Angeles", "value"=>1363622597}, "headsign"=>"Seattle Pacific University, Seattle Center W", "line"=>{"agencies"=>[{"name"=>"Metro Transit", "phone"=>"(206) 553-3000", "url"=>"http://metro.kingcounty.gov/"}], "short_name"=>"13", "url"=>"http://metro.kingcounty.gov/tops/bus/schedules/s013_0_.html", "vehicle"=>{"icon"=>"//maps.gstatic.com/mapfiles/transit/iw/6/bus.png", "name"=>"Bus", "type"=>"BUS"}}, "num_stops"=>11}, "travel_mode"=>"TRANSIT"}, {"distance"=>{"text"=>"0.5 mi", "value"=>875}, "duration"=>{"text"=>"9 mins", "value"=>558}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Walk to Seattle, WA 98109, USA", "polyline"=>{"points"=>"euuaHfwxiV?Nh@@?}D?G@GBKBKFK`@Q@IBGBGBE|@aBA}B?cC?oABk@?}AAiD?aGBgG?{B?iC@_G?kB"}, "start_location"=>{"lat"=>47.62979000000001, "lng"=>-122.35652}, "steps"=>[{"distance"=>{"text"=>"79 ft", "value"=>24}, "duration"=>{"text"=>"1 min", "value"=>13}, "end_location"=>{"lat"=>47.62958, "lng"=>-122.35661}, "html_instructions"=>"Head <b>south</b> on <b>Queen Anne Ave N</b> toward <b>W Highland Dr</b>", "polyline"=>{"points"=>"euuaHfwxiV?Nh@@"}, "start_location"=>{"lat"=>47.62979000000001, "lng"=>-122.35652}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"305 ft", "value"=>93}, "duration"=>{"text"=>"1 min", "value"=>83}, "end_location"=>{"lat"=>47.62949000000001, "lng"=>-122.3554}, "html_instructions"=>"Turn <b>left</b> onto <b>Highland Dr</b>", "polyline"=>{"points"=>"{suaHxwxiV?}D?G@GBKBKFK"}, "start_location"=>{"lat"=>47.62958, "lng"=>-122.35661}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"0.5 mi", "value"=>758}, "duration"=>{"text"=>"8 mins", "value"=>462}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"<b>Highland Dr</b> turns slightly <b>right</b> and becomes <b>Prospect St</b>", "polyline"=>{"points"=>"isuaHfpxiV`@Q@IBGBGBE|@aBA}B?cC?oABk@?}AAiD?aGBgG?{B?iC@_G?kB"}, "start_location"=>{"lat"=>47.62949000000001, "lng"=>-122.3554}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}], "via_waypoint"=>[]}], "overview_polyline"=>{"points"=>"soqaHrztiViGrFcBzAGQDNs@n@}E|EmMlWwC`GwCxF_F~JkIpPbE`GbAvAq@rAiBrDa@`AqBjE_@t@{@?wKAaMCuGCmD?AdGs@?uGAqFCmA?kDIk@A?S?Nh@@?eEDSJW`@Q@IFO`AgBAaGB{BAgGBiO?eG@kJ"}, "warnings"=>["Walking directions are in beta.    Use caution – This route may be missing sidewalks or pedestrian paths."], "waypoint_order"=>[]}, {"bounds"=>{"northeast"=>{"lat"=>47.62913, "lng"=>-122.33658}, "southwest"=>{"lat"=>47.60842, "lng"=>-122.3489}}, "copyrights"=>"Map data ©2013 Google, Sanborn", "legs"=>[{"arrival_time"=>{"text"=>"9:41am", "time_zone"=>"America/Los_Angeles", "value"=>1363624878}, "departure_time"=>{"text"=>"9:25am", "time_zone"=>"America/Los_Angeles", "value"=>1363623936}, "distance"=>{"text"=>"1.8 mi", "value"=>2899}, "duration"=>{"text"=>"16 mins", "value"=>966}, "end_address"=>"Seattle, WA 98109, USA", "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "start_address"=>"Seattle, WA 98101, USA", "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"0.1 mi", "value"=>240}, "duration"=>{"text"=>"3 mins", "value"=>188}, "end_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "html_instructions"=>"Walk to 3rd Ave & Pike St", "polyline"=>{"points"=>"soqaHrztiVaA|@gEtDcBzAGQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "steps"=>[{"distance"=>{"text"=>"0.1 mi", "value"=>240}, "duration"=>{"text"=>"3 mins", "value"=>188}, "end_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "html_instructions"=>"Head <b>northwest</b> on <b>3rd Ave</b> toward <b>Union St</b>", "polyline"=>{"points"=>"soqaHrztiVaA|@gEtDcBzAGQ"}, "start_location"=>{"lat"=>47.60842, "lng"=>-122.33658}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"1.6 mi", "value"=>2595}, "duration"=>{"text"=>"12 mins", "value"=>734}, "end_location"=>{"lat"=>47.62913, "lng"=>-122.34612}, "html_instructions"=>"Bus towards E Queen Anne, Seattle Center E", "polyline"=>{"points"=>"i{qaHpduiVDNs@n@k@j@qDpDyCbGi@fAoBxDyCfGeBhDq@vAw@|A_BzCCHEHgBnDmBzDo@nA}@hB_AqAcAyAq@}@KKIAQE{@AE?c@?U@i@AO?_A?u@?kDCW?K?Y?mA?wCAUQwECcA?kD?SNoDAiD@?_C?kB?YoD?o@?c@?yAAuA?yA?k@A?U"}, "start_location"=>{"lat"=>47.61029000000001, "lng"=>-122.33817}, "transit_details"=>{"arrival_stop"=>{"location"=>{"lat"=>47.6291275, "lng"=>-122.346123}, "name"=>"Taylor Ave N & Prospect St"}, "arrival_time"=>{"text"=>"9:40am", "time_zone"=>"America/Los_Angeles", "value"=>1363624836}, "departure_stop"=>{"location"=>{"lat"=>47.6102905, "lng"=>-122.338173}, "name"=>"3rd Ave & Pike St"}, "departure_time"=>{"text"=>"9:28am", "time_zone"=>"America/Los_Angeles", "value"=>1363624102}, "headsign"=>"E Queen Anne, Seattle Center E", "line"=>{"agencies"=>[{"name"=>"Metro Transit", "phone"=>"(206) 553-3000", "url"=>"http://metro.kingcounty.gov/"}], "short_name"=>"4", "url"=>"http://metro.kingcounty.gov/tops/bus/schedules/s004_0_.html", "vehicle"=>{"icon"=>"//maps.gstatic.com/mapfiles/transit/iw/6/bus.png", "name"=>"Bus", "type"=>"BUS"}}, "num_stops"=>8}, "travel_mode"=>"TRANSIT"}, {"distance"=>{"text"=>"210 ft", "value"=>64}, "duration"=>{"text"=>"1 min", "value"=>44}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Walk to Seattle, WA 98109, USA", "polyline"=>{"points"=>"aquaHfvviV?Tj@??kB"}, "start_location"=>{"lat"=>47.62913, "lng"=>-122.34612}, "steps"=>[{"distance"=>{"text"=>"79 ft", "value"=>24}, "duration"=>{"text"=>"1 min", "value"=>14}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34623}, "html_instructions"=>"Head <b>south</b> on <b>Taylor Ave N</b> toward <b>Prospect St</b>", "polyline"=>{"points"=>"aquaHfvviV?Tj@?"}, "start_location"=>{"lat"=>47.62913, "lng"=>-122.34612}, "travel_mode"=>"WALKING"}, {"distance"=>{"text"=>"131 ft", "value"=>40}, "duration"=>{"text"=>"1 min", "value"=>30}, "end_location"=>{"lat"=>47.62891, "lng"=>-122.34569}, "html_instructions"=>"Turn <b>left</b> onto <b>Prospect St</b>", "polyline"=>{"points"=>"uouaH|vviV?kB"}, "start_location"=>{"lat"=>47.62891, "lng"=>-122.34623}, "travel_mode"=>"WALKING"}], "travel_mode"=>"WALKING"}], "via_waypoint"=>[]}], "overview_polyline"=>{"points"=>"soqaHrztiViGrFcBzAGQDNs@n@}E|EmMlWwC`GwCxF_F~JmBxDcCkD}@iA[GaAAy@@oDAiFCeFAUQwECoF?SNoDAiD@?_C?eC}IAoD?k@A?U?Tj@??kB"}, "warnings"=>["Walking directions are in beta.    Use caution – This route may be missing sidewalks or pedestrian paths."], "waypoint_order"=>[]}], "status"=>"OK"}

    parsed["status"] = "FAIL"

    unless parsed["status"] == "OK"
      flash[:alert] = "Trip not stored. Problems with your request."
      #@json = parsed
      render 'new'
      return
    end

    @trip.origin_name = parsed["routes"][0]["legs"][0]["start_address"]
    @trip.destination_name = parsed["routes"][0]["legs"][-1]["end_address"]
    @trip.raw_response = parsed.to_json.to_s

    if @trip.save
      flash[:notice] = "Trip stored, but not saved to user"
      redirect_to trip_path(@trip)
    else
      flash[:alert] = "Trip not stored"
      #@json = parsed
      render 'new'
    end
  end

  def show
    @trip = Trip.find(params[:id])
    #@json = JSON.parse(@trip.raw_response)
    # this action will trigger SAVING the trip for the current user.
    # in create, the trip is saved but not assigned a user
    # in order to edit, delete, etc, the trip must first be saved
  end

  private

  def authenticate_user!
    # this is identical to ticketee
  end
end
